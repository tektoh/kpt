
<html>
  <head>
    <title>KPT</title>
    <link href="http://maxcdn.bootstrapcdn.com/bootswatch/3.3.1/cerulean/bootstrap.min.css" rel="stylesheet">
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="http://www.parsecdn.com/js/parse-1.3.3.min.js"></script>
    <script src="js/config.js"></script>
    <script>
    $(document).ready(function() {
      var global = {
        vote: 0,
        max_vote: 3
      };

      var currentUser = Parse.User.current();
      if (!currentUser) {
        location.href = 'login.html';
      }

      var params = $.getUrlVars();

      $('#logoutButton').on('click', function() {
        Parse.User.logOut();
        location.href = 'login.html';
      });

      $('.inputCard').on('click', function() {
        var label = $(this).data('label');
        var inputId;
        switch (label) {
          case 'keep':
            inputId = '#inputKeep';
            break;
          case 'problem':
            inputId = '#inputProblem';
            break;
          case 'try':
            inputId = '#inputTry';
            break;
        }

        var Card = Parse.Object.extend("Card");
        var card = new Card();
        card.set('createdBy', currentUser);
        card.set('title', $(inputId).val());
        card.set('vote', 0);
        card.save(null, {
          success: function(card) {
            var kpt = global.kpt;
            var relation = kpt.relation(label);
            relation.add(card);
            kpt.save(null, {
              success: function() {
                render();
              },
              error: function(kpt, error) {
                alert('Failed to create new object, with error code: ' + error.message);
              }
            });
          },
          error: function(card, error) {
            lert('Failed to create new object, with error code: ' + error.message);
          }
        });
      });

      $(document).on('click', '.voteButton', function() {
        var vote = Number($(this).data('vote'));
        var objectId = $(this).data('cardid');

        if (vote > 0 && global.vote >= global.max_vote) {
          return;
        }

        if (vote < 0 && global.vote <= 0) {
          return;
        }

        var Card = Parse.Object.extend("Card");
        var query = new Parse.Query(Card);
        query.equalTo('objectId', objectId);
        query.first({
          success: function(card) {
            var v = card.get('vote');

            v = v + vote;
            card.set('vote', v);

            card.save(null, {
              success: function() {
                global.vote = global.vote + vote;
                render();
              },
              error: function(card, error) {
                alert('Failed to create new object, with error code: ' + error.message);
              }
            });
          }
        });
      });

      $(document).on('click', '.deleteButton', function() {
        var objectId = $(this).data('cardid');
        var Card = Parse.Object.extend("Card");
        var query = new Parse.Query(Card);
        query.equalTo('objectId', objectId);
        query.first({
          success: function(card) {
            card.destroy({
              success: function(card) {
                render();
              }
            });
          }
        });
      });

      render();

      return;

      function render() {
        $('#voteCount').html(global.max_vote - global.vote);

        var Kpt = Parse.Object.extend("Kpt");
        var query = new Parse.Query(Kpt);
        query.equalTo('objectId', params.id);
        query.first({
          success: function(kpt) {
            global.kpt = kpt;

            $('#title').html(kpt.get('title'));

            kpt.relation('keep').query().addDescending('vote').find({
              success: function(results) {
                renderCards('keep', results);
              }
            });

            kpt.relation('problem').query().addDescending('vote').find({
              success: function(results) {
                renderCards('problem', results);
              }
            });

            kpt.relation('try').query().addDescending('vote').find({
              success: function(results) {
                renderCards('try', results);
              }
            });
          },
          error: function(error) {
            alert("Error: " + error.code + " " + error.message);
          }
        });
      }

      function renderCards(label, cards) {
        var listId = '#' + label + 'List';

        $(listId).html('');

        for (var i = 0; i < cards.length; i++) {
          var card = cards[i];
          $(listId).append(
            '<li class="list-group-item">' +
            '<span class="badge">' + card.get('vote') + '</span>' +
            '<h4>' + card.get('title') + '</h4>' +
            '<div class="text-right">' +
            '<button class="deleteButton btn btn-link btn-sm" data-cardid=' + card.id + '>Delete</button>' +
            '<button class="voteButton btn btn-primary btn-sm" data-vote="1" data-cardid=' + card.id + '>+1</button>' +
            '</div>' +
            '</li>'
          );
        }
      }
    });

    $.extend({
      getUrlVars: function(){
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
          hash = hashes[i].split('=');
          vars.push(hash[0]);
          vars[hash[0]] = hash[1];
        }
        return vars;
      },
      getUrlVar: function(name){
        return $.getUrlVars()[name];
      }
    });
    </script>
  </head>
  <body>
    <div class="container">

      <div class="pull-left">
        <a href="index.html" class="btn btn-link">Back</a>
      </div>

      <div class="page-header">
        <h1 id='title' class="text-center"></h1>
      </div>

      <div class="text-right">
        <small>vote:<span id="voteCount"></span></small>
      </div>

      <div clas="row">
        <div class="col col-xs-4">
          <h2 class="text-center">KEEP</h2>
        </div>
        <div class="col col-xs-4">
          <h2 class="text-center">PROBLEM</h2>
        </div>
        <div class="col col-xs-4">
          <h2 class="text-center">TRY</h2>
        </div>
      </div>

      <div clas="row">
        <div class="col col-xs-4">
          <ul id="keepList" class="list-group"></ul>
          <div class="form-group">
            <input type="text" class="form-control" id="inputKeep">
          </div>
          <button type="submit" class="btn btn-primary inputCard" data-label="keep">ADD</button>
        </div>
        <div class="col col-xs-4">
          <ul id="problemList" class="list-group"></ul>
          <div class="form-group">
            <input type="text" class="form-control" id="inputProblem">
          </div>
          <button type="submit" class="btn btn-primary inputCard" data-label="problem">ADD</button>
        </div>
        <div class="col col-xs-4">
          <ul id="tryList" class="list-group"></ul>
          <div class="form-group">
            <input type="text" class="form-control" id="inputTry">
          </div>
          <button type="submit" class="btn btn-primary inputCard" data-label="try">ADD</button>
        </div>
      </div>
    </div>
  </body>
</html>
